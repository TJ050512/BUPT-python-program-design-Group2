# é˜Ÿå‹å¯¹æ¥æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•å°†**æ•°æ®åº“æ¨¡å—**ä¸ä¸»ç³»ç»Ÿå¯¹æ¥ã€‚é¡¹ç›®å·²æ”¹ä¸ºæœ¬åœ°æ•°æ®æ¨¡å¼ï¼Œä¸å†éœ€è¦ç½‘ç»œçˆ¬è™«ã€‚

## ğŸ—„ï¸ æ•°æ®åº“æ¨¡å—å¯¹æ¥

### 1. éœ€è¦æä¾›çš„æ¥å£

è¯·åœ¨ä½ çš„æ•°æ®åº“æ¨¡å—ä¸­æä¾›ä¸€ä¸ª `DatabaseManager` ç±»ï¼Œä½äº `database_module.py` æ–‡ä»¶ä¸­ã€‚

### 2. ç±»æ¥å£å®šä¹‰

```python
# database_module.py

class DatabaseManager:
    """æ•°æ®åº“ç®¡ç†ç±»"""
    
    def __init__(self, config: dict):
        """
        åˆå§‹åŒ–æ•°æ®åº“è¿æ¥
        
        Args:
            config: é…ç½®å­—å…¸
                {
                    'type': 'sqlite',      # æ•°æ®åº“ç±»å‹
                    'path': 'data/app.db', # SQLiteè·¯å¾„
                    # æˆ–è€… MySQL/PostgreSQL:
                    # 'host': 'localhost',
                    # 'port': 3306,
                    # 'database': 'mydb',
                    # 'user': 'root',
                    # 'password': 'password'
                }
        """
        pass
    
    def query(self, sql: str, params: tuple = None) -> list:
        """
        æ‰§è¡ŒæŸ¥è¯¢è¯­å¥
        
        Args:
            sql: SQLæŸ¥è¯¢è¯­å¥ï¼ˆä½¿ç”¨?ä½œä¸ºå‚æ•°å ä½ç¬¦ï¼‰
            params: æŸ¥è¯¢å‚æ•°å…ƒç»„
        
        Returns:
            list[dict]: æŸ¥è¯¢ç»“æœåˆ—è¡¨ï¼Œæ¯è¡Œä¸ºä¸€ä¸ªå­—å…¸
        
        Example:
            result = db.query("SELECT * FROM users WHERE username=?", ('admin',))
            # è¿”å›: [{'id': 1, 'username': 'admin', 'password': '...', 'role': 'admin'}, ...]
        """
        pass
    
    def execute(self, sql: str, params: tuple = None) -> int:
        """
        æ‰§è¡Œå¢åˆ æ”¹è¯­å¥
        
        Args:
            sql: SQLè¯­å¥
            params: å‚æ•°å…ƒç»„
        
        Returns:
            int: å½±å“çš„è¡Œæ•°
        
        Example:
            affected = db.execute("UPDATE users SET password=? WHERE id=?", ('newhash', 1))
        """
        pass
    
    def insert(self, table: str, data: dict) -> int:
        """
        æ’å…¥æ•°æ®ï¼ˆä¾¿æ·æ–¹æ³•ï¼‰
        
        Args:
            table: è¡¨å
            data: æ•°æ®å­—å…¸
        
        Returns:
            int: æ–°æ’å…¥è®°å½•çš„ID
        
        Example:
            user_id = db.insert('users', {
                'username': 'test',
                'password': 'hash',
                'role': 'user'
            })
        """
        pass
    
    def update(self, table: str, data: dict, condition: dict) -> int:
        """
        æ›´æ–°æ•°æ®
        
        Args:
            table: è¡¨å
            data: è¦æ›´æ–°çš„æ•°æ®å­—å…¸
            condition: æ›´æ–°æ¡ä»¶å­—å…¸
        
        Returns:
            int: å½±å“çš„è¡Œæ•°
        
        Example:
            db.update('users', 
                {'password': 'new_hash'}, 
                {'username': 'test'})
        """
        pass
    
    def delete(self, table: str, condition: dict) -> int:
        """
        åˆ é™¤æ•°æ®
        
        Args:
            table: è¡¨å
            condition: åˆ é™¤æ¡ä»¶å­—å…¸
        
        Returns:
            int: å½±å“çš„è¡Œæ•°
        
        Example:
            db.delete('users', {'id': 5})
        """
        pass
    
    def close(self):
        """å…³é—­æ•°æ®åº“è¿æ¥"""
        pass
```

### 3. æ•°æ®è¡¨ç»“æ„

è¯·åˆ›å»ºä»¥ä¸‹æ•°æ®è¡¨ï¼š

#### ç”¨æˆ·è¡¨ (users)

```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,  -- å­˜å‚¨å“ˆå¸Œåçš„å¯†ç 
    role VARCHAR(20) NOT NULL,       -- 'admin' æˆ– 'user'
    email VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP
);
```

#### æ•°æ®è®°å½•è¡¨ (data_records)

æ ¹æ®å®é™…ä¸šåŠ¡è°ƒæ•´å­—æ®µï¼š

```sql
CREATE TABLE data_records (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title VARCHAR(200),
    content TEXT,
    category VARCHAR(50),
    source VARCHAR(100),          -- æ•°æ®æ¥æº
    url VARCHAR(500),             -- åŸå§‹URL
    author VARCHAR(100),
    publish_time TIMESTAMP,       -- å‘å¸ƒæ—¶é—´
    crawl_time TIMESTAMP,         -- çˆ¬å–æ—¶é—´
    views INTEGER DEFAULT 0,      -- æµè§ˆé‡ï¼ˆå¦‚æœæœ‰ï¼‰
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### æ“ä½œæ—¥å¿—è¡¨ (operation_logs)

```sql
CREATE TABLE operation_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    action VARCHAR(50),           -- æ“ä½œç±»å‹
    target VARCHAR(100),          -- æ“ä½œç›®æ ‡
    details TEXT,                 -- è¯¦ç»†ä¿¡æ¯
    ip_address VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### 4. åˆå§‹åŒ–æ•°æ®

è¯·åœ¨æ•°æ®åº“ä¸­æ’å…¥ä»¥ä¸‹æµ‹è¯•ç”¨æˆ·ï¼š

```sql
-- ç®¡ç†å‘˜è´¦å·ï¼ˆå¯†ç : admin123ï¼‰
INSERT INTO users (username, password, role, email) VALUES 
('admin', '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewY5GyYqNNKq7rJy', 'admin', 'admin@example.com');

-- æ™®é€šç”¨æˆ·è´¦å·ï¼ˆå¯†ç : user123ï¼‰
INSERT INTO users (username, password, role, email) VALUES 
('user', '$2b$12$8k7sxJF4bNxzKv3lWJ5LjOKvPBvGqK5VJ8qYE6LZxFj3qLXxNxJQO', 'user', 'user@example.com');
```

æ³¨æ„ï¼šå¯†ç ä½¿ç”¨bcryptå“ˆå¸Œã€‚å¦‚æœéœ€è¦é‡æ–°ç”Ÿæˆå“ˆå¸Œï¼Œå¯ä»¥è¿è¡Œï¼š

```python
from utils.crypto import CryptoUtil
print(CryptoUtil.hash_password('admin123'))
```

### 5. é›†æˆæ–¹å¼

å°†ä½ çš„ `database_module.py` æ–‡ä»¶æ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹ï¼Œæˆ‘ä¼šåœ¨ `data/database_interface.py` ä¸­å¯¼å…¥ä½¿ç”¨ï¼š

```python
# data/database_interface.py ä¸­
from database_module import DatabaseManager

class DatabaseInterface:
    def __init__(self, config):
        self.db = DatabaseManager(config)
    
    def query_user_by_username(self, username):
        result = self.db.query("SELECT * FROM users WHERE username=?", (username,))
        return result[0] if result else None
```

---

## ğŸš« çˆ¬è™«æ¨¡å—å·²ç§»é™¤

é¡¹ç›®å½“å‰å…¨éƒ¨æ•°æ®æ¥è‡ªæœ¬åœ°ï¼Œå·²åˆ é™¤ `data/crawler_interface.py` ä»¥åŠç›¸å…³é…ç½®ã€‚
è¯·ä¸è¦å†äº¤ä»˜ `crawler_module.py` æˆ–å®ç°ä»»ä½•ç½‘ç»œçˆ¬è™«æ¥å£ã€‚

å¦‚æœåç»­éœ€æ±‚å˜åŒ–éœ€è¦é‡æ–°å¯ç”¨ç½‘ç»œçˆ¬è™«ï¼Œæˆ‘ä»¬ä¼šå¦èµ·æ–‡æ¡£è¯´æ˜æ–°çš„æ¥å£å’Œæ•°æ®æ ¼å¼ã€‚

---

## ğŸ”„ é›†æˆæµç¨‹

### ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡æ¨¡å—æ–‡ä»¶

```
é¡¹ç›®æ ¹ç›®å½•/
â”œâ”€â”€ database_module.py    # ä½ çš„æ•°æ®åº“æ¨¡å—
â””â”€â”€ ... (å…¶ä»–æ–‡ä»¶)
```

### ç¬¬äºŒæ­¥ï¼šæµ‹è¯•æ•°æ®åº“æ¨¡å—

åˆ›å»ºæµ‹è¯•è„šæœ¬ `test_database.py`ï¼š

```python
from database_module import DatabaseManager

# åˆå§‹åŒ–
config = {'type': 'sqlite', 'path': 'data/app.db'}
db = DatabaseManager(config)

# æµ‹è¯•æŸ¥è¯¢
users = db.query("SELECT * FROM users")
print(f"ç”¨æˆ·æ•°é‡: {len(users)}")
for user in users:
    print(f"  - {user['username']} ({user['role']})")

# æµ‹è¯•æ’å…¥
test_data = {
    'title': 'æµ‹è¯•æ•°æ®',
    'content': 'è¿™æ˜¯æµ‹è¯•å†…å®¹',
    'category': 'æµ‹è¯•'
}
record_id = db.insert('data_records', test_data)
print(f"æ’å…¥è®°å½•ID: {record_id}")

# å…³é—­è¿æ¥
db.close()
```

è¿è¡Œæµ‹è¯•ï¼š
```bash
python test_database.py
```

### ç¬¬ä¸‰æ­¥ï¼šè”è°ƒ

- ç¡®ä¿ `database_module.py` èƒ½è¢« `data/database_interface.py` æ­£å¸¸å¯¼å…¥ã€‚
- è¿è¡Œ `python main.py`ï¼Œä½¿ç”¨æµ‹è¯•è´¦å·ï¼ˆå¦‚ `admin / admin123`ï¼‰ç™»å½•ï¼Œç¡®è®¤æœ¬åœ°æ•°æ®è¯»å–æ­£å¸¸ã€‚
- å¦‚æœæœ‰è‡ªå®šä¹‰è¡¨æˆ–å­—æ®µï¼Œè®°å¾—åŒæ­¥åœ¨ `data/models.py` é‡Œæ›´æ–°å¯¹åº”çš„æ•°æ®æ¨¡å‹ã€‚

---

## â“ å¸¸è§é—®é¢˜

### Q1: æ•°æ®åº“ä½¿ç”¨SQLiteè¿˜æ˜¯MySQLï¼Ÿ

**A:** æ¨èä½¿ç”¨SQLiteï¼Œç®€å•æ˜“ç”¨ï¼Œæ— éœ€é¢å¤–å®‰è£…æ•°æ®åº“æœåŠ¡å™¨ã€‚å¦‚æœæƒ³ä½¿ç”¨MySQLï¼Œéœ€è¦ï¼š
```bash
pip install pymysql
```

### Q2: å¦‚ä½•å¯¼å…¥æˆ–æ›´æ–°æœ¬åœ°æ•°æ®ï¼Ÿ

**A:** æ¨èä½¿ç”¨ä»¥ä¸‹æ–¹å¼ä¹‹ä¸€ï¼š

- ç›´æ¥åœ¨ SQLite æ•°æ®åº“ä¸­æ‰§è¡Œ SQL è„šæœ¬ï¼ˆå¦‚ `sqlite3 data/app.db < scripts/init.sql`ï¼‰ã€‚
- ç¼–å†™ä¸€æ¬¡æ€§è„šæœ¬ï¼Œè°ƒç”¨ `DatabaseManager.insert` / `DatabaseManager.execute` å†™å…¥æµ‹è¯•æ•°æ®ã€‚
- å¦‚æœæ•°æ®é‡è¾ƒå¤§ï¼Œå¯ä»¥å…ˆç”¨ CSV æ•´ç†ï¼Œå†é€šè¿‡ Python è„šæœ¬è¯»å–å¹¶æ‰¹é‡å…¥åº“ã€‚

### Q4: æ•°æ®åº“å¯†ç å¦‚ä½•ç”Ÿæˆï¼Ÿ

**A:** ä½¿ç”¨æˆ‘æä¾›çš„åŠ å¯†å·¥å…·ï¼š

```python
from utils.crypto import CryptoUtil

password = "your_password"
hashed = CryptoUtil.hash_password(password)
print(hashed)
```

---

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰ç–‘é—®ï¼Œè¯·éšæ—¶æ²Ÿé€šï¼

- å¯ä»¥åœ¨é¡¹ç›®ç›®å½•åˆ›å»º `questions.md` è®°å½•é—®é¢˜
- æˆ–ç›´æ¥ä¸æˆ‘è®¨è®ºæ¥å£ç»†èŠ‚

## âœ… æ£€æŸ¥æ¸…å•

å®Œæˆåè¯·ç¡®è®¤ï¼š

- [ ] `database_module.py` æ–‡ä»¶å·²åˆ›å»º
- [ ] `DatabaseManager` ç±»çš„æ‰€æœ‰æ–¹æ³•å·²å®ç°
- [ ] æ•°æ®è¡¨å·²åˆ›å»ºå¹¶åˆå§‹åŒ–æµ‹è¯•æ•°æ®
- [ ] æ•°æ®åº“æ¨¡å—æµ‹è¯•é€šè¿‡
- [ ] åœ¨ `data/database_interface.py` ä¸­é€šè¿‡æµ‹è¯•è„šæœ¬å®ŒæˆåŸºæœ¬ CRUD éªŒè¯
- [ ] æœ¬åœ°ç™»å½•æµç¨‹ï¼ˆ`python main.py`ï¼‰å·²ç»éªŒè¯é€šè¿‡

ç¥å¼€å‘é¡ºåˆ©ï¼ ğŸš€


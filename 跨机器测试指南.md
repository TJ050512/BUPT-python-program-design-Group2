# 跨机器网络测试指南

## 📋 测试准备

### 环境要求
- **两台电脑**：一台作为服务器，一台作为客户端
- **网络连接**：两台电脑必须在同一局域网（如连接同一WiFi或路由器）
- **Python环境**：两台电脑都需要安装Python 3.8+及项目依赖

---

## 🖥️ 服务器端（电脑A）

### 步骤1：启动服务器

```bash
python 启动服务器.py
```

启动后会显示：
```
📡 服务器信息：
  监听地址: 0.0.0.0:8888 (所有网络接口)
  本机IP: 192.168.1.100  ← 记下这个IP地址
  最大连接数: 20

💡 客户端连接方式：
  本机测试: python 客户端测试.py localhost
  局域网测试: python 客户端测试.py 192.168.1.100
```

**重要：记下显示的"本机IP"，客户端需要用这个IP连接！**

### 步骤2：确认服务器正常运行

看到以下日志表示服务器已启动成功：
```
[INFO] 服务器启动成功，监听 0.0.0.0:8888
[INFO] 所有消息处理器注册完成
```

### 步骤3：配置防火墙（重要！）

#### Windows系统

1. **打开Windows防火墙设置**
   - 按 `Win + R`，输入 `control firewall.cpl`
   - 或搜索"Windows Defender 防火墙"

2. **添加入站规则**
   - 点击左侧"高级设置"
   - 选择"入站规则" → "新建规则"
   - 选择"端口" → 下一步
   - 选择"TCP"，输入端口 `8888` → 下一步
   - 选择"允许连接" → 下一步
   - 勾选所有配置文件 → 下一步
   - 输入名称"教学管理系统服务器" → 完成

#### 快速测试方法（临时）

```bash
# PowerShell管理员运行
New-NetFirewallRule -DisplayName "教学管理系统" -Direction Inbound -Protocol TCP -LocalPort 8888 -Action Allow
```

#### macOS系统

```bash
# 系统偏好设置 → 安全性与隐私 → 防火墙 → 防火墙选项
# 添加Python到允许列表
```

---

## 💻 客户端（电脑B）

### 前提条件

1. **获取服务器IP**：从服务器端启动信息中获取（如 192.168.1.100）
2. **确认网络连通**：Ping测试服务器

```bash
ping 192.168.1.100
```

如果能收到回复，说明网络连通。

### 方法1：使用测试脚本（推荐）

```bash
# 直接指定服务器IP
python 客户端测试.py 192.168.1.100

# 或运行后输入IP
python 客户端测试.py
# 然后输入: 192.168.1.100
```

### 方法2：编写自己的客户端

```python
from network.client import Client
from network.protocol import Protocol

# 创建客户端（替换为实际的服务器IP）
client = Client(host='192.168.1.100', port=8888)

# 连接服务器
success, msg = client.connect()
if success:
    print("✓ 连接成功")
    
    # 登录测试
    response = client.login('2021211001', 'student123')
    if response['status'] == 'success':
        print(f"✓ 登录成功: {response['data']['name']}")
    
    # 断开连接
    client.disconnect()
else:
    print(f"✗ 连接失败: {msg}")
```

---

## 🧪 完整测试流程

### 测试场景1：本机测试

**服务器端：**
```bash
python 启动服务器.py
```

**客户端（同一台电脑的另一个终端）：**
```bash
python 客户端测试.py localhost
```

### 测试场景2：局域网测试（两台电脑）

**电脑A（服务器）：**
```bash
python 启动服务器.py
# 记下显示的IP：192.168.1.100
```

**电脑B（客户端）：**
```bash
# 先测试网络连通
ping 192.168.1.100

# 运行客户端测试
python 客户端测试.py 192.168.1.100
```

**预期输出：**
```
✓ 连接成功
✓ 登录成功
  用户信息: 李明 (student)
✓ 获取成功，共4门课程
✓ 获取成功，共0条成绩记录
✓ 所有测试通过！
```

### 测试场景3：多客户端并发测试

在多台电脑上同时运行客户端：

**电脑B：**
```bash
python 客户端测试.py 192.168.1.100
```

**电脑C：**
```bash
python 客户端测试.py 192.168.1.100
```

**电脑D：**
```bash
python 客户端测试.py 192.168.1.100
```

服务器会显示多个客户端连接的日志。

---

## 🔧 故障排查

### 问题1：客户端连接超时

**症状：**
```
✗ 连接失败: 连接超时
```

**解决方法：**

1. **检查服务器是否启动**
   ```bash
   # 在服务器端检查是否有启动日志
   [INFO] 服务器启动成功，监听 0.0.0.0:8888
   ```

2. **检查IP地址是否正确**
   - 确认使用的是服务器端显示的"本机IP"
   - 不要使用 127.0.0.1 或 localhost（除非在同一台电脑）

3. **检查网络连通性**
   ```bash
   ping 192.168.1.100
   ```
   
4. **检查防火墙**
   - Windows: 确认已添加端口8888的入站规则
   - 临时关闭防火墙测试（不推荐长期关闭）

5. **检查端口是否被占用**
   ```bash
   # Windows
   netstat -ano | findstr 8888
   
   # Linux/macOS
   netstat -an | grep 8888
   ```

### 问题2：连接被拒绝

**症状：**
```
✗ 连接失败: [Errno 10061] 由于目标计算机积极拒绝，无法连接
```

**原因：**
- 服务器未启动
- 端口号错误
- 防火墙阻止

**解决：**
1. 确认服务器已启动
2. 确认使用端口8888
3. 检查防火墙设置

### 问题3：无法获取服务器IP

**获取方法：**

**Windows：**
```bash
ipconfig
# 查看 "IPv4 地址" 或 "无线局域网适配器"
```

**Linux/macOS：**
```bash
ifconfig
# 或
ip addr show
```

**Python方式：**
```python
import socket
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
s.connect(("8.8.8.8", 80))
print(f"本机IP: {s.getsockname()[0]}")
s.close()
```

### 问题4：数据接收不完整

**症状：**
- 某些请求成功，某些失败
- 日志显示"接收数据失败"

**原因：**
- 网络不稳定
- 数据包过大

**解决：**
```python
# 增加客户端超时时间
client = Client(host='192.168.1.100', port=8888, timeout=60)
```

---

## 📊 性能测试

### 测试服务器承载能力

创建 `并发测试.py`：

```python
import threading
import time
from network.client import Client

def test_client(client_id, server_ip):
    """单个客户端测试"""
    client = Client(host=server_ip, port=8888)
    
    success, _ = client.connect()
    if success:
        print(f"✓ 客户端{client_id}: 连接成功")
        
        # 登录
        response = client.login('2021211001', 'student123')
        if response and response['status'] == 'success':
            print(f"✓ 客户端{client_id}: 登录成功")
        
        time.sleep(2)  # 保持连接2秒
        client.disconnect()
    else:
        print(f"✗ 客户端{client_id}: 连接失败")

def main(server_ip, num_clients=10):
    """并发测试主函数"""
    print(f"开始并发测试: {num_clients}个客户端")
    
    threads = []
    start_time = time.time()
    
    for i in range(num_clients):
        t = threading.Thread(target=test_client, args=(i+1, server_ip))
        threads.append(t)
        t.start()
    
    for t in threads:
        t.join()
    
    end_time = time.time()
    print(f"\n测试完成，用时: {end_time - start_time:.2f}秒")

if __name__ == "__main__":
    main('192.168.1.100', num_clients=10)
```

运行：
```bash
python 并发测试.py
```

---

## 📱 测试账号

### 学生账号
| 用户名 | 密码 | 姓名 |
|--------|------|------|
| 2021211001 | student123 | 李明 |
| 2021211002 | student123 | 王芳 |
| 2021211003 | student123 | 张伟 |

### 教师账号
| 用户名 | 密码 | 姓名 | 职称 |
|--------|------|------|------|
| teacher001 | teacher123 | 张教授 | 教授 |
| teacher002 | teacher123 | 李副教授 | 副教授 |
| teacher003 | teacher123 | 王讲师 | 讲师 |

### 管理员账号
| 用户名 | 密码 |
|--------|------|
| admin | admin123 |

---

## 🎯 验收标准

完成以下测试即可认为网络对接成功：

- [ ] 服务器成功启动并显示本机IP
- [ ] 客户端能够连接到服务器（显示"连接成功"）
- [ ] 学生能够登录并获取课程列表
- [ ] 教师能够登录并获取教师课程
- [ ] 多个客户端可以同时连接
- [ ] 服务器日志正常记录所有操作
- [ ] 客户端断开连接后服务器能正常继续运行

---

## 💡 最佳实践

1. **服务器端**
   - 使用 `0.0.0.0` 监听所有网络接口
   - 配置防火墙允许8888端口
   - 定期查看日志文件 `logs/app.log`

2. **客户端**
   - 先用 `ping` 测试网络连通
   - 使用实际IP地址而非localhost
   - 设置合理的超时时间（10-30秒）

3. **调试技巧**
   - 查看服务器端日志：`tail -f logs/app.log`
   - 使用Wireshark抓包分析
   - 逐步测试：先连接 → 再登录 → 再业务操作

4. **安全建议**
   - 生产环境使用SSL/TLS加密
   - 密码使用哈希存储
   - 限制连接速率防止攻击
   - 记录所有操作日志

---

## 📞 常见问题

**Q: 为什么只能本机连接，其他电脑连接失败？**

A: 检查以下几点：
1. 服务器是否使用 `0.0.0.0` 而非 `localhost`
2. 防火墙是否允许端口8888
3. 两台电脑是否在同一局域网

**Q: 如何知道服务器的IP地址？**

A: 运行 `启动服务器.py` 后会自动显示，或使用 `ipconfig`/`ifconfig` 命令查看。

**Q: 可以通过互联网连接吗？**

A: 默认配置仅支持局域网。如需互联网访问，需要：
1. 配置路由器端口转发
2. 使用公网IP或动态域名
3. 增强安全措施（SSL/TLS、认证）

**Q: 最多支持多少个客户端？**

A: 默认最大连接数为20，可以在创建服务器时修改：
```python
server = Server(host='0.0.0.0', port=8888, max_connections=100)
```

---

## ✅ 测试检查清单

打印此清单用于测试验收：

```
□ 服务器启动成功
□ 获取到服务器IP地址: _______________
□ 防火墙已配置允许端口8888
□ 本机客户端连接测试通过
□ 远程客户端连接测试通过
□ 学生登录功能正常
□ 教师登录功能正常
□ 获取课程列表功能正常
□ 选课功能正常（如果需要）
□ 获取成绩功能正常
□ 多客户端并发测试通过
□ 断开重连功能正常
□ 日志记录完整
```

---

## 📚 相关文档

- [网络对接说明.md](网络对接说明.md) - 详细的API文档
- [README.md](README.md) - 项目总体说明
- [快速开始指南.md](快速开始指南.md) - 快速上手指南

---

**祝测试顺利！如有问题请查看日志文件或联系技术支持。**


